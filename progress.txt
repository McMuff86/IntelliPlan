# IntelliPlan - Ralph Progress Log

## Codebase Patterns
<!-- Add reusable patterns here as they are discovered -->
<!-- Example: Use `sql<number>` template for aggregations -->
<!-- Example: Always use `IF NOT EXISTS` for migrations -->

---

## Iteration Log
<!-- Each Ralph iteration appends its progress below -->
  
## 2026-01-13 - US-001  
Thread: https://ampcode.com/threads/T-019bb959-ef98-70d3-8968-161c39a15ead  
- Backend: Node.js/Express with TypeScript initialized  
- Frontend: React with Vite, Material-UI, TypeScript initialized  
- Database: PostgreSQL migrations created (teams, users, appointments)  
- Migration runner at npm run migrate  
  
**Files created:**  
- backend/ - Full Express API structure  
- frontend/ - Full React app structure  
- backend/migrations/ - SQL migration files  
  
**Learnings for future iterations:**  
- Use IF NOT EXISTS for all CREATE TABLE/INDEX statements  
- Vite requires type-only imports (import type) for verbatimModuleSyntax  
- ESLint v9 requires flat config but we used legacy .eslintrc.json  
--- 
  
## 2026-01-14 - US-002  
Thread: https://ampcode.com/threads/T-019bb959-ef98-70d3-8968-161c39a15ead  
- POST /api/appointments endpoint created  
- Validates title, startTime, endTime with express-validator  
- Returns 201 with created appointment  
- Returns 400 with validation errors  
  
**Files created:**  
- models/appointment.ts - Types and response mapper  
- services/appointmentService.ts - Database operations  
- controllers/appointmentController.ts - Request handling  
- validators/appointmentValidator.ts - Input validation  
- routes/appointments.ts - Route definitions  
  
**Learnings:**  
- Use camelCase in API (startTime) but snake_case in DB (start_time)  
- toAppointmentResponse() maps between formats  
---

## 2026-01-14 - US-003
Thread: https://ampcode.com/threads/T-019bbad3-bf06-7019-a96f-5be88384398f
- GET /api/appointments endpoint with pagination (limit, offset)
- GET /api/appointments/:id endpoint for single appointment
- Date range filtering via ?start=&end= query params
- 404 response for non-existent appointments
- User ownership enforced (users only see their own)

**Files modified:**
- services/appointmentService.ts - Added getAppointments() and getAppointmentById()
- controllers/appointmentController.ts - Added list() and getById() handlers
- routes/appointments.ts - Added GET routes

**Learnings:**
- req.params.id can be string | string[] in Express types - use `as string` assertion
- req.headers values can be string | string[] - handle array case with ternary
---

## 2026-01-14 - US-004
Thread: https://ampcode.com/threads/T-019bbb04-2438-7386-97cc-7c73c53fc01a
- PUT /api/appointments/:id endpoint created
- Validates ownership before update (returns 403 if not owner)
- Partial updates supported (only provided fields are updated)
- Returns 200 with updated appointment, 404 if not found, 403 if unauthorized

**Files modified:**
- models/appointment.ts - Added UpdateAppointmentDTO interface
- services/appointmentService.ts - Added getAppointmentOwner() and updateAppointment()
- controllers/appointmentController.ts - Added update() handler
- validators/appointmentValidator.ts - Added updateAppointmentValidator (all fields optional)
- routes/appointments.ts - Added PUT /:id route

**Learnings:**
- For partial updates, build SQL SET clause dynamically with parameterized index
- Check ownership separately from fetching appointment to return proper 403 vs 404
- ValidationChain type import needed for explicit validator array typing
---

## 2026-01-14 - US-005
Thread: https://ampcode.com/threads/T-019bbb0d-33d6-75bb-84b7-fcc0b79edc4d
- DELETE /api/appointments/:id endpoint created
- Validates ownership before deletion (403 if not owner)
- Returns 204 on successful deletion
- Returns 404 for non-existent appointments
- Implements soft delete (sets deleted_at timestamp)

**Files modified:**
- services/appointmentService.ts - Added deleteAppointment() function
- controllers/appointmentController.ts - Added remove() handler
- routes/appointments.ts - Added DELETE /:id route

**Learnings:**
- Soft delete pattern: UPDATE SET deleted_at = NOW() instead of DELETE
- All queries already filter with deleted_at IS NULL for consistency
---

## 2026-01-14 - US-006
Thread: https://ampcode.com/threads/T-019bbb1f-47ad-75ae-9433-c69c6cb516ac
- Overlap detection service implemented
- checkOverlap() function detects conflicts using: start_time < new_end AND end_time > new_start
- Integrated into POST /api/appointments and PUT /api/appointments/:id
- Returns 409 Conflict with conflicts array when overlap detected
- Accepts ?force=true query param to override conflict blocking
- excludeId parameter used in update to exclude the appointment being updated

**Files modified:**
- models/appointment.ts - Added OverlapResult interface
- services/appointmentService.ts - Added checkOverlap() function
- controllers/appointmentController.ts - Integrated overlap check in create() and update()

**Learnings:**
- Overlap detection formula: new_start < existing_end AND new_end > existing_start
- Use excludeId to prevent self-conflict when updating an appointment
- 409 Conflict is appropriate HTTP status for scheduling conflicts
---

## 2026-01-14 - US-007
Thread: https://ampcode.com/threads/T-019bbb3e-1987-7039-9175-a79483176f4b
- AppointmentForm component created with react-hook-form and MUI date pickers
- Fields: title (required), description, start date/time, end date/time, timezone
- Form validation with error messages (required fields, end > start)
- Loading state during submission (CircularProgress, disabled fields)
- Handles 409 conflict response to show overlap warning with "Create Anyway" option
- CreateAppointment page with navigation at /appointments/new

**Files created:**
- frontend/src/components/AppointmentForm/AppointmentForm.tsx
- frontend/src/components/AppointmentForm/index.ts
- frontend/src/pages/CreateAppointment.tsx
- frontend/src/services/appointmentService.ts

**Files modified:**
- frontend/src/types/index.ts - Added CreateAppointmentDTO, AppointmentFormData, OverlapConflict
- frontend/src/App.tsx - Added route for /appointments/new

**Learnings:**
- Use date-fns-tz's fromZonedTime() to convert local time to UTC for API
- MUI DateTimePicker uses slotProps.textField for error/helperText display
- Handle 409 Conflict by showing conflicts and offering force submit
---

## 2026-01-14 - US-008
Thread: https://ampcode.com/threads/T-019bbb52-fbb3-7116-b81b-c3b722ad34f8
- Created OverlapWarningDialog component using MUI Dialog
- Replaced inline Alert warning with modal dialog
- Dialog shows warning icon, conflict list, Cancel and "Create Anyway" buttons
- Integrated into AppointmentForm for both create and edit flows

**Files created:**
- frontend/src/components/OverlapWarningDialog/OverlapWarningDialog.tsx
- frontend/src/components/OverlapWarningDialog/index.ts

**Files modified:**
- frontend/src/components/AppointmentForm/AppointmentForm.tsx - Uses OverlapWarningDialog

**Learnings:**
- MUI Dialog uses DialogTitle, DialogContent, DialogActions structure
- Use warning.light color for visual warning styling on conflict list
---

## 2026-01-14 - US-009
Thread: https://ampcode.com/threads/T-019bbb6f-4d93-70de-bb8a-862b4582d5a1
- Created AppointmentsList component using MUI Table
- List displays appointments sorted by start date
- Shows title, start time, end time for each appointment
- Click on row navigates to appointment details (route prepared for US-010)
- Delete button with confirmation dialog
- Empty state with message and "Create Appointment" button
- Added getAll() and delete() methods to appointmentService
- Added /appointments route with Appointments page

**Files created:**
- frontend/src/components/AppointmentsList/AppointmentsList.tsx
- frontend/src/components/AppointmentsList/index.ts
- frontend/src/pages/Appointments.tsx

**Files modified:**
- frontend/src/services/appointmentService.ts - Added getAll() and delete() methods
- frontend/src/App.tsx - Added /appointments route

**Learnings:**
- Use toZonedTime() from date-fns-tz to convert UTC to user's timezone for display
- MUI Table with hover and cursor pointer for clickable rows
- Stop event propagation on action buttons to prevent row click navigation
---

## 2026-01-14 - US-010
Thread: https://ampcode.com/threads/T-019bbb79-fa8f-74cc-b0e7-a50bee78f99d
- Created AppointmentDetail page component at /appointments/:id
- Displays all appointment fields (title, description, times, timezone)
- Edit button navigates to /appointments/:id/edit (route to be added)
- Delete button with confirmation dialog, navigates back to list after deletion
- Back navigation to /appointments
- Added getById() method to frontend appointmentService
- Added start-dev.ps1 script for running both servers simultaneously

**Files created:**
- frontend/src/pages/AppointmentDetail.tsx
- start-dev.ps1

**Files modified:**
- frontend/src/services/appointmentService.ts - Added getById() method
- frontend/src/App.tsx - Added /appointments/:id route
- AGENTS.md - Added development setup documentation

**Learnings:**
- Use useParams<{ id: string }>() from react-router-dom for typed route params
- Format dates with date-fns format() after converting from UTC with toZonedTime()
- start-dev.ps1 uses Start-Process to spawn separate PowerShell windows for backend/frontend
---

## 2026-01-14 - US-011
Thread: https://ampcode.com/threads/T-019bbbb3-962f-706b-af62-ffb8b2e06c9b
- Created CalendarView component using FullCalendar library
- Monthly grid view with appointment events displayed on dates
- Previous/Next month navigation with "today" button
- Click on date opens dialog showing appointments for that day
- Click on appointment navigates to detail view (/appointments/:id)
- Added /calendar route with Calendar page

**Files created:**
- frontend/src/components/CalendarView/CalendarView.tsx
- frontend/src/components/CalendarView/index.ts
- frontend/src/pages/Calendar.tsx

**Files modified:**
- frontend/src/App.tsx - Added /calendar route
- frontend/package.json - Added FullCalendar dependencies

**Learnings:**
- FullCalendar: DateClickArg comes from @fullcalendar/interaction, EventClickArg from @fullcalendar/core
- FullCalendar events need id, title, start, end properties
- Use dayMaxEvents={3} to limit visible events per day and show "+more" link
---
""  
"## 2026-01-14 - US-012"  
"Thread: https://ampcode.com/threads/T-019bbe16-f8e6-709b-87ff-325ed78b969b"  
"- Added @fullcalendar/timegrid plugin for week and day views"  
"- Created Month/Week/Day toggle with MUI ToggleButtonGroup"  
"- Week view shows 7-day grid with time slots (06:00-22:00)"  
"- Day view shows single day with time slots"  
"- Appointments positioned by time in timeGrid views"  
"- Now indicator shows current time in week/day views"  
""  
"**Files modified:**"  
"- frontend/src/components/CalendarView/CalendarView.tsx - Added timeGridPlugin and view toggle"  
"- frontend/package.json - Added @fullcalendar/timegrid dependency"  
""  
"**Learnings:**"  
"- FullCalendar timeGridPlugin provides timeGridWeek and timeGridDay views"  
"- Use calendarRef.getApi().changeView() to programmatically switch views"  
"- slotMinTime/slotMaxTime control visible time range in timeGrid views"  
"- nowIndicator={true} shows current time line in week/day views"  
"---" 
  
## 2026-01-14 - US-013  
Thread: https://ampcode.com/threads/T-019bbe22-65eb-74fa-9b29-538d323e1bf8  
- Enabled drag-and-drop rescheduling in CalendarView  
- Appointments can be dragged to new date in month view  
- Appointments can be dragged/resized to new time slots in week/day views  
- Visual feedback provided by FullCalendar during drag  
- Immediate save on drop with success/error snackbar feedback  
- Overlap warning dialog displayed when conflict detected  
- Reschedule Anyway option to force update despite conflicts  
  
**Files modified:**  
- frontend/src/components/CalendarView/CalendarView.tsx - Added drag-and-drop handlers, overlap dialog, snackbar  
  
**Learnings:**  
- FullCalendar interactionPlugin provides editable=true for drag-and-drop  
- EventDropArg and EventResizeDoneArg both have event and revert function  
- Use revert to undo visual change when API call fails  
- Store pending drop info to allow force update after user confirms overlap  
--- 
  
## 2026-01-14 - US-014  
Thread: https://ampcode.com/threads/T-019bbe22-65eb-74fa-9b29-538d323e1bf8  
- Created unified Appointments page with List/Calendar view toggle  
- View preference persisted to localStorage  
- URLs reflect current view: /appointments/list and /appointments/calendar  
- /appointments redirects to preferred view, /calendar redirects to /appointments/calendar  
- Smooth CSS transition between views  
- Deleted standalone Calendar.tsx page  
  
**Files created/modified:**  
- frontend/src/pages/Appointments.tsx - Added view toggle with localStorage persistence  
- frontend/src/App.tsx - Updated routes for list/calendar paths  
- Deleted frontend/src/pages/Calendar.tsx  
  
**Learnings:**  
- Avoid setState in useEffect to prevent cascading renders  
- Use useMemo to derive state from URL pathname  
- Navigate imperatively when URL is base /appointments  
--- 
  
## 2026-01-14 - US-015  
Thread: https://ampcode.com/threads/T-019bbe22-65eb-74fa-9b29-538d323e1bf8  
- Created user model and userService for role/team lookup  
- Created roleMiddleware with requireRole and loadUser functions  
- Updated appointmentService with isAdmin and filterUserId options  
- Admin can view all appointments via GET /api/appointments  
- Admin can filter by userId query param  
- Admin can edit/delete any appointment (bypasses ownership check)  
- loadUser middleware loads req.user from x-user-id header  
  
**Files created:**  
- backend/src/models/user.ts - User types and response mapper  
- backend/src/services/userService.ts - getUserById, getUserRole, getUserTeamId  
- backend/src/middleware/roleMiddleware.ts - requireRole and loadUser middleware  
  
**Files modified:**  
- backend/src/services/appointmentService.ts - Added isAdmin, filterUserId options  
- backend/src/controllers/appointmentController.ts - Updated all endpoints for admin access  
- backend/src/routes/appointments.ts - Added loadUser middleware  
  
**Learnings:**  
- Extend Express Request type with declare global for req.user  
- Use loadUser middleware to optionally populate user context  
- Admin bypasses ownership checks but still triggers overlap detection for appointment owner  
--- 
  
## 2026-01-14 - US-016  
Thread: https://ampcode.com/threads/T-019bbe22-65eb-74fa-9b29-538d323e1bf8  
- Updated appointmentService to support team queries with includeTeam and teamId options  
- Team users can view team members appointments via ?includeTeam=true query param  
- API returns isOwn flag to distinguish own vs team appointments  
- getAppointmentById supports team visibility (read-only access for team members)  
- Edit/delete still enforces ownership check (team members cannot edit others)  
- Added isOwn field to frontend Appointment type  
  
**Files modified:**  
- backend/src/services/appointmentService.ts - Added teamId, includeTeam options, overloaded getAppointmentById  
- backend/src/controllers/appointmentController.ts - Added isOwn to response, team query support  
- frontend/src/types/index.ts - Added isOwn optional field  
  
**Learnings:**  
- Use function overloading to maintain backward compatibility while adding new options  
- JOIN users table to filter by team_id when querying appointments  
- isOwn flag enables frontend to visually distinguish own vs team appointments  
--- 
